<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Koop Databricks Provider - ArcGIS Map Test</title>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #info {
      position: absolute;
      top: 15px;
      left: 60px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 99;
      max-width: 400px;
    }
  </style>
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.28/"></script>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer"
    ], function(Map, MapView, FeatureLayer) {

      // URL to your Koop provider via Cloudflare Tunnel
      const serviceUrl = "https://jaguar-lancaster-controlled-jar.trycloudflare.com/databricks/rest/services/main.default.koop_test_cities/FeatureServer/0";

      console.log("Testing Koop provider at:", serviceUrl);

      const featureLayer = new FeatureLayer({
        url: serviceUrl,
        outFields: ["*"],
        popupTemplate: {
          title: "{city_name}, {state}",
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "population",
                  label: "Population",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: "objectid",
                  label: "Object ID"
                }
              ]
            }
          ]
        }
      });

      const map = new Map({
        basemap: "topo-vector",
        layers: [featureLayer]
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-95, 38], // Center of USA
        zoom: 4
      });

      // Log layer load status
      featureLayer.load().then(function() {
        console.log("✅ FeatureLayer loaded successfully!");
        console.log("Layer info:", {
          title: featureLayer.title,
          geometryType: featureLayer.geometryType,
          fields: featureLayer.fields.map(f => f.name),
          objectIdField: featureLayer.objectIdField
        });

        document.getElementById("status").innerHTML = "✅ <strong>Layer loaded successfully!</strong>";

        // Query for all features
        featureLayer.queryFeatures({
          where: "1=1",
          outFields: ["*"],
          returnGeometry: true
        }).then(function(results) {
          console.log(`✅ Query returned ${results.features.length} features`);
          document.getElementById("count").innerHTML = `Found ${results.features.length} cities`;

          // Log first feature
          if (results.features.length > 0) {
            const first = results.features[0];
            console.log("First feature:", first.attributes);
          }
        }).catch(function(error) {
          console.error("❌ Query error:", error);
          document.getElementById("status").innerHTML = "❌ Query failed: " + error.message;
        });

      }).catch(function(error) {
        console.error("❌ Layer load error:", error);
        document.getElementById("status").innerHTML = "❌ <strong>Layer failed to load:</strong> " + error.message;
      });

      view.whenLayerView(featureLayer).then(function(layerView) {
        console.log("✅ LayerView created successfully");
      }).catch(function(error) {
        console.error("❌ LayerView error:", error);
      });
    });
  </script>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="info">
    <h3>Koop Databricks Provider Test</h3>
    <div id="status">⏳ Loading layer...</div>
    <div id="count"></div>
    <p style="font-size: 12px; margin-top: 10px; color: #666;">
      Check browser console (F12) for detailed logs
    </p>
  </div>
</body>
</html>
